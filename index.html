<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>โปรแกรมคำนวณค่าไฟค่าน้ำ</title>
  <style>
    body { font-family: 'Courier New', monospace; padding: 20px; background: #f2f2f2; }
    .container { background: #fff; padding: 20px; max-width: 600px; margin: auto; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    input, select { width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; }
    button { width: 100%; padding: 12px; background: #007bff; border: none; border-radius: 6px; color: white; font-size: 16px; margin-top: 10px; cursor: pointer; }
    button:hover { background: #0056c1; }
    .result { background: #fafafa; padding: 15px; margin-top: 20px; border-radius: 10px; border: 1px solid #ddd; white-space: pre-line; font-family: 'Courier New', monospace; font-size: 15px; }
    .history { margin-top: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #fff; border-radius: 8px; }
    .history-item { border-bottom: 1px solid #ddd; padding: 5px 0; }
    .history-item button { width: auto; padding: 5px 10px; margin-top: 5px; font-size: 14px; }
    @media print {
      @page { size: A5 portrait; margin: 20mm; }
      body { background: white; padding: 0; }
      .container { box-shadow: none; width: auto; margin: 0; }
      button { display: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>โปรแกรมคำนวณค่าไฟค่าน้ำ</h2>

    <label>ชื่อห้อง</label>
    <input id="room" placeholder="เช่น 101" />

    <label>วัน/เดือน/ปี</label>
    <input id="date" type="date" />

    <label>เลขมิเตอร์ไฟครั้งก่อน</label>
    <input id="old_elec" type="number" step="1" />

    <label>เลขมิเตอร์ไฟครั้งนี้</label>
    <input id="new_elec" type="number" step="1" />

    <label>เลขมิเตอร์น้ำครั้งก่อน</label>
    <input id="old_water" type="number" step="1" />

    <label>เลขมิเตอร์น้ำครั้งนี้</label>
    <input id="new_water" type="number" step="1" />

    <label>ค่าห้อง</label>
    <input id="room_cost" type="number" step="1" />

    <button onclick="calc()">คำนวณ</button>
    <button onclick="printPDF()">พิมพ์ใบเสร็จ</button>
    <button onclick="clearInputs()">เคลียร์ข้อมูลที่กรอก</button>

    <div id="result" class="result"></div>

    <h3>ประวัติการคำนวณ</h3>
    <div id="history" class="history"></div>

    <button onclick="clearHistory()">เคลียร์ประวัติทั้งหมด</button>
  </div>

  <script>
    let currentData = {};
    let historyData = [];

    function calc() {
      const room = document.getElementById('room').value;
      const date = document.getElementById('date').value;
      const old_elec = parseInt(document.getElementById('old_elec').value, 10);
      const new_elec = parseInt(document.getElementById('new_elec').value, 10);
      const old_water = parseInt(document.getElementById('old_water').value, 10);
      const new_water = parseInt(document.getElementById('new_water').value, 10);
      const room_cost = parseFloat(document.getElementById('room_cost').value);

      if (new_elec < old_elec) { alert('เลขมิเตอร์ไฟครั้งใหม่ต้องไม่ต่ำกว่าเลขครั้งก่อน'); return; }
      if (new_water < old_water) { alert('เลขมิเตอร์น้ำครั้งใหม่ต้องไม่ต่ำกว่าเลขครั้งก่อน'); return; }

      const elec_rate = 7.0;
      const water_rate = 16;

      const elec_use = new_elec - old_elec;
      const water_use = new_water - old_water;

      const elec_cost = elec_use * elec_rate;
      const water_cost = water_use * water_rate;
      const total = elec_cost + water_cost + room_cost;

      currentData = { room, date, old_elec, new_elec, old_water, new_water, elec_use, water_use, elec_cost, water_cost, room_cost, total };

      document.getElementById('result').textContent = formatBill(currentData);

      historyData.push(currentData);
      updateHistory();
    }

    function formatBill(data) {
      return `=== ใบแจ้งค่าใช้จ่ายห้อง ${data.room} ===\n` +
             `วันที่: ${data.date}\n` +
             `เลขมิเตอร์ไฟ: ครั้งก่อน ${data.old_elec} ครั้งนี้ ${data.new_elec}\n` +
             `เลขมิเตอร์น้ำ: ครั้งก่อน ${data.old_water} ครั้งนี้ ${data.new_water}\n` +
             `ใช้ไฟ: ${data.elec_use} หน่วย × 7 บาท = ${data.elec_cost.toFixed(2)}\n` +
             `ใช้น้ำ: ${data.water_use} หน่วย × 16 บาท = ${data.water_cost.toFixed(2)}\n` +
             `ค่าห้อง: ${data.room_cost.toFixed(1)} บาท\n` +
             `รวมทั้งสิ้น: ${data.total.toFixed(2)} บาท\n` +
             `===========================`;
    }

    function updateHistory() {
      const historyDiv = document.getElementById('history');
      historyDiv.innerHTML = '';
      historyData.forEach((d) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'history-item';
        itemDiv.innerHTML = `<pre>${formatBill(d)}</pre>` +
                            `<button onclick='printSingle(${historyData.indexOf(d)})'>พิมพ์ใบเสร็จ</button>`;
        historyDiv.appendChild(itemDiv);
      });
    }

    function printSingle(index) {
      const data = historyData[index];
      const printContent = formatBill(data);
      const win = window.open('', '', 'width=600,height=800');
      win.document.write(`<!DOCTYPE html><html><head><title>ใบเสร็จ</title>
        <style>
          @page { size: A5 portrait; margin: 20mm; }
          body { font-family: 'Courier New', monospace; white-space: pre-line; font-size: 16px; }
        </style>
      </head><body><pre>${printContent}</pre></body></html>`);
      win.document.close();
      win.print();
    }

    function clearHistory() {
      historyData = [];
      updateHistory();
    }

    function clearInputs() {
      document.getElementById('room').value = '';
      document.getElementById('date').value = '';
      document.getElementById('old_elec').value = '';
      document.getElementById('new_elec').value = '';
      document.getElementById('old_water').value = '';
      document.getElementById('new_water').value = '';
      document.getElementById('room_cost').value = '';
      document.getElementById('result').textContent = '';
    }

    function printPDF() {
      if (!currentData.room) { alert('กรุณากดคำนวณก่อนพิมพ์'); return; }
      const printContent = formatBill(currentData);
      const win = window.open('', '', 'width=600,height=800');
      win.document.write(`<!DOCTYPE html><html><head><title>ใบเสร็จ</title>
        <style>
          @page { size: A5 portrait; margin: 20mm; }
          body { font-family: 'Courier New', monospace; white-space: pre-line; font-size: 16px; }
        </style>
      </head><body><pre>${printContent}</pre></body></html>`);
      win.document.close();
      win.print();
    }
  </script>
</body>
</html>
